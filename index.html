<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jewel International Currency Unit</title>
    
    <!-- Solana Web3 and Wallet Adapter Dependencies -->
    <script src="https://unpkg.com/@solana/web3.js@latest/lib/index.iife.min.js"></script>
    <script src="https://unpkg.com/@solana/wallet-adapter-wallets@latest/lib/index.iife.min.js"></script>
    <!-- spl-token IIFE removed (dropped in newer versions); helpers inlined below -->
    <script src="https://unpkg.com/@project-serum/anchor@latest/dist/browser/anchor.js"></script>
    
    <!-- Google reCAPTCHA v3 (optional for now) -->
    <!-- <script src="https://www.google.com/recaptcha/api.js?render=YOUR_RECAPTCHA_SITE_KEY"></script> -->
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background-color: #000;
            color: #fff;
            overflow-x: hidden;
        }

        /* Header Styles */
        .header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: rgba(0, 0, 0, 0.9);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(255, 215, 0, 0.3);
            padding: 15px 30px;
            z-index: 1000;
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 15px;
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .header-logo {
            font-size: 1.5rem;
            font-weight: bold;
            color: #FFD700;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
        }

        /* Wallet Connection Styles */
        .wallet-section {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .wallet-button {
            background: linear-gradient(135deg, #FFD700, #FFA500);
            color: #000;
            border: none;
            padding: 10px 20px;
            border-radius: 25px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            box-shadow: 0 4px 15px rgba(255, 215, 0, 0.3);
        }

        .wallet-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(255, 215, 0, 0.5);
            background: linear-gradient(135deg, #FFA500, #FFD700);
        }

        .wallet-button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .wallet-button svg {
            width: 20px;
            height: 20px;
        }

        .wallet-connected {
            display: flex;
            align-items: center;
            gap: 10px;
            background: rgba(255, 215, 0, 0.1);
            padding: 8px 16px;
            border-radius: 25px;
            border: 1px solid rgba(255, 215, 0, 0.3);
        }

        .wallet-address {
            color: #FFD700;
            font-family: monospace;
            font-size: 14px;
        }

        .disconnect-button {
            background: rgba(255, 0, 0, 0.2);
            color: #ff6b6b;
            border: 1px solid rgba(255, 0, 0, 0.3);
            padding: 6px 12px;
            border-radius: 15px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .disconnect-button:hover {
            background: rgba(255, 0, 0, 0.3);
            border-color: rgba(255, 0, 0, 0.5);
        }

        /* Airdrop Button Styles */
        .airdrop-button {
            background: linear-gradient(135deg, #9C27B0, #E91E63);
            color: #fff;
            border: none;
            padding: 10px 20px;
            border-radius: 25px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            box-shadow: 0 4px 15px rgba(156, 39, 176, 0.3);
            margin-left: 10px;
            position: relative;
            overflow: hidden;
        }

        .airdrop-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(156, 39, 176, 0.5);
            background: linear-gradient(135deg, #E91E63, #9C27B0);
        }

        .airdrop-button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        /* Buy JEWEL Button (x402) */
        .buy-button {
            background: linear-gradient(135deg, #00C853, #00E676);
            color: #000;
            border: none;
            padding: 10px 20px;
            border-radius: 25px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            box-shadow: 0 4px 15px rgba(0, 200, 83, 0.3);
            margin-left: 10px;
        }

        .buy-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 200, 83, 0.5);
            background: linear-gradient(135deg, #00E676, #00C853);
        }

        .buy-button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        /* Purchase Modal (x402) */
        #purchaseModal {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.85);
            z-index: 2000;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        #purchaseModal.active {
            display: flex;
        }

        .purchase-modal-content {
            background: #111;
            border: 2px solid #00C853;
            border-radius: 16px;
            padding: 30px;
            max-width: 420px;
            width: 100%;
        }

        .purchase-modal-content h2 {
            color: #00E676;
            margin-bottom: 6px;
            font-size: 1.4rem;
        }

        .x402-badge {
            font-size: 11px;
            color: #00C853;
            border: 1px solid #00C853;
            border-radius: 10px;
            padding: 2px 8px;
            display: inline-block;
            margin-bottom: 18px;
        }

        .purchase-input-label {
            color: #ccc;
            font-size: 14px;
            margin-bottom: 6px;
            display: block;
        }

        .purchase-amount-input {
            width: 100%;
            padding: 12px;
            border-radius: 8px;
            background: #1a1a1a;
            border: 1px solid #333;
            color: #fff;
            font-size: 16px;
            margin-bottom: 14px;
        }

        .purchase-amount-input:focus {
            outline: none;
            border-color: #00C853;
        }

        .purchase-summary {
            background: rgba(0, 200, 83, 0.08);
            border: 1px solid rgba(0, 200, 83, 0.3);
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 18px;
            font-size: 14px;
            color: #ccc;
        }

        .purchase-summary span {
            color: #00E676;
            font-weight: bold;
        }

        .purchase-confirm-btn {
            width: 100%;
            padding: 13px;
            border-radius: 10px;
            background: linear-gradient(135deg, #00C853, #00E676);
            color: #000;
            font-weight: bold;
            font-size: 15px;
            border: none;
            cursor: pointer;
            transition: opacity 0.2s;
        }

        .purchase-confirm-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .purchase-close-btn {
            float: right;
            background: none;
            border: none;
            color: #888;
            font-size: 22px;
            cursor: pointer;
            line-height: 1;
            margin-top: -4px;
        }

        .purchase-close-btn:hover {
            color: #fff;
        }

        .airdrop-button svg {
            width: 20px;
            height: 20px;
        }

        .airdrop-button.loading {
            pointer-events: none;
        }

        .airdrop-button.loading::after {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
            animation: shimmer 1.5s infinite;
        }

        @keyframes shimmer {
            to {
                left: 100%;
            }
        }

        /* Airdrop Status Styles */
        .airdrop-status {
            font-size: 12px;
            color: #888;
            margin-top: 5px;
        }
        
        .airdrop-success {
            color: #4CAF50;
        }
        
        .airdrop-error {
            color: #f44336;
        }
        
        .transaction-link {
            color: #FFD700;
            text-decoration: none;
            font-size: 12px;
            margin-top: 5px;
            display: inline-block;
        }
        
        .transaction-link:hover {
            text-decoration: underline;
        }

        /* Toast Notification Styles */
        .toast {
            position: fixed;
            top: 80px;
            right: 20px;
            background: rgba(0, 0, 0, 0.9);
            color: #fff;
            padding: 15px 20px;
            border-radius: 10px;
            border: 1px solid rgba(255, 215, 0, 0.3);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
            z-index: 2000;
            opacity: 0;
            transform: translateX(100%);
            transition: all 0.3s ease;
            max-width: 300px;
        }

        .toast.show {
            opacity: 1;
            transform: translateX(0);
        }

        .toast.success {
            border-color: #4caf50;
            background: rgba(76, 175, 80, 0.1);
        }

        .toast.error {
            border-color: #f44336;
            background: rgba(244, 67, 54, 0.1);
        }

        .toast.info {
            border-color: #2196f3;
            background: rgba(33, 150, 243, 0.1);
        }

        .container {
            margin-top: 70px; /* Account for fixed header */
            position: relative;
            width: 100vw;
            height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .splash-image {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
            z-index: 1;
        }

        .overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(
                45deg,
                rgba(0, 0, 0, 0.3),
                rgba(0, 0, 0, 0.1)
            );
            z-index: 2;
        }

        .banner {
            position: relative;
            z-index: 3;
            background: linear-gradient(
                135deg,
                rgba(255, 215, 0, 0.9),
                rgba(255, 165, 0, 0.9)
            );
            padding: 20px 40px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            text-align: center;
            backdrop-filter: blur(10px);
            border: 2px solid rgba(255, 215, 0, 0.3);
            animation: glow 2s ease-in-out infinite alternate;
        }

        .banner h1 {
            font-size: 2.5rem;
            font-weight: bold;
            color: #000;
            text-shadow: 2px 2px 4px rgba(255, 255, 255, 0.3);
            letter-spacing: 2px;
            margin: 0;
        }

        .banner p {
            font-size: 1.2rem;
            color: #333;
            margin-top: 10px;
            font-weight: 500;
        }

        @keyframes glow {
            from {
                box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5),
                           0 0 20px rgba(255, 215, 0, 0.3);
            }
            to {
                box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5),
                           0 0 40px rgba(255, 215, 0, 0.6);
            }
        }

        @media (max-width: 768px) {
            .header {
                padding: 10px 15px;
            }

            .header-logo {
                font-size: 1.2rem;
            }

            .wallet-button {
                padding: 8px 15px;
                font-size: 12px;
            }

            .wallet-button svg {
                width: 16px;
                height: 16px;
            }

            .wallet-address {
                font-size: 12px;
            }

            .toast {
                right: 10px;
                left: 10px;
                max-width: none;
            }

            .banner h1 {
                font-size: 1.8rem;
            }
            
            .banner {
                padding: 15px 25px;
                margin: 0 20px;
            }
            
            .banner p {
                font-size: 1rem;
            }
        }

        @media (max-width: 480px) {
            .banner h1 {
                font-size: 1.4rem;
                letter-spacing: 1px;
            }
            
            .banner {
                padding: 12px 20px;
            }
        }

        @media (max-width: 768px) {
            .instructions {
                padding: 20px;
                margin-top: 20px;
                width: 95%;
                max-height: 50vh;
            }

            .instructions h2 {
                font-size: 1.5rem;
            }

            .step {
                padding: 15px;
            }

            .step h3 {
                font-size: 1.1rem;
            }

            .app-link, .buy-link {
                padding: 10px 20px;
                font-size: 0.9rem;
            }

            .buy-link {
                padding: 12px 25px;
                font-size: 1rem;
            }
        }

        @media (max-width: 480px) {
            .instructions {
                padding: 15px;
                margin-top: 15px;
                max-height: 45vh;
            }

            .instructions h2 {
                font-size: 1.3rem;
                margin-bottom: 20px;
            }

            .step {
                padding: 12px;
            }

            .step h3 {
                font-size: 1rem;
            }

            .step p {
                font-size: 0.9rem;
            }

            .app-link, .buy-link {
                padding: 8px 16px;
                font-size: 0.8rem;
            }

            .buy-link {
                padding: 10px 20px;
                font-size: 0.9rem;
            }
        }

        .instructions {
            position: relative;
            z-index: 3;
            background: rgba(0, 0, 0, 0.8);
            padding: 30px;
            border-radius: 15px;
            margin-top: 30px;
            max-width: 800px;
            width: 90%;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 215, 0, 0.3);
            max-height: 60vh;
            overflow-y: auto;
        }

        .instructions h2 {
            color: #FFD700;
            font-size: 1.8rem;
            text-align: center;
            margin-bottom: 25px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
        }

        .steps {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .step {
            background: rgba(255, 215, 0, 0.1);
            padding: 20px;
            border-radius: 10px;
            border-left: 4px solid #FFD700;
        }

        .step h3 {
            color: #FFD700;
            font-size: 1.2rem;
            margin-bottom: 10px;
        }

        .step p {
            color: #fff;
            margin-bottom: 10px;
            line-height: 1.5;
        }

        .app-link, .buy-link {
            display: inline-block;
            background: linear-gradient(135deg, #FFD700, #FFA500);
            color: #000;
            padding: 12px 24px;
            text-decoration: none;
            border-radius: 8px;
            font-weight: bold;
            transition: all 0.3s ease;
            margin-top: 10px;
        }

        .app-link:hover, .buy-link:hover {
            background: linear-gradient(135deg, #FFA500, #FFD700);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(255, 215, 0, 0.4);
        }

        .buy-link {
            background: linear-gradient(135deg, #FF6B35, #F7931E);
            font-size: 1.1rem;
            padding: 15px 30px;
        }

        .buy-link:hover {
            background: linear-gradient(135deg, #F7931E, #FF6B35);
        }

        .footer {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 3;
            color: rgba(255, 255, 255, 0.7);
            font-size: 0.9rem;
            text-align: center;
        }

        /* Chatbot Styles */
        .chatbot-container {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 1000;
        }

        .chatbot-toggle {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: linear-gradient(135deg, #FFD700, #FFA500);
            border: none;
            cursor: pointer;
            box-shadow: 0 4px 20px rgba(255, 215, 0, 0.4);
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            animation: pulse 2s infinite;
        }

        .chatbot-toggle:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 25px rgba(255, 215, 0, 0.6);
        }

        .chatbot-toggle svg {
            width: 30px;
            height: 30px;
            fill: #000;
        }

        @keyframes pulse {
            0% { box-shadow: 0 4px 20px rgba(255, 215, 0, 0.4); }
            50% { box-shadow: 0 4px 20px rgba(255, 215, 0, 0.8); }
            100% { box-shadow: 0 4px 20px rgba(255, 215, 0, 0.4); }
        }

        .chatbot-window {
            position: absolute;
            bottom: 80px;
            right: 0;
            width: 400px;
            height: 600px;
            background: rgba(0, 0, 0, 0.95);
            border-radius: 15px;
            border: 2px solid #FFD700;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(10px);
            display: none;
            flex-direction: column;
            overflow: hidden;
        }

        .chatbot-window.active {
            display: flex;
            flex-direction: column;
        }

        .chatbot-header {
            background: linear-gradient(135deg, #FFD700, #FFA500);
            color: #000;
            padding: 15px 20px;
            font-weight: bold;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: relative;
        }
        
        .chatbot-header-controls {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .chatbot-expand {
            background: rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(0, 0, 0, 0.2);
            border-radius: 4px;
            color: #000;
            font-size: 16px;
            cursor: pointer;
            padding: 2px;
            width: 30px;
            height: 30px;
            display: none; /* Hidden by default, shown on mobile */
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }
        
        .chatbot-expand:hover {
            background: rgba(0, 0, 0, 0.2);
            transform: scale(1.05);
        }
        
        .chatbot-expand:active {
            transform: scale(0.95);
        }

        .chatbot-close {
            background: none;
            border: none;
            color: #000;
            font-size: 20px;
            cursor: pointer;
            padding: 0;
            width: 25px;
            height: 25px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        /* Fullscreen mode for mobile */
        .chatbot-window.fullscreen {
            position: fixed !important;
            top: 0 !important;
            left: 0 !important;
            right: 0 !important;
            bottom: 0 !important;
            width: 100vw !important;
            height: 100vh !important;
            max-height: 100vh !important;
            border-radius: 0 !important;
            z-index: 10000 !important;
            margin: 0 !important;
        }
        
        .chatbot-window.fullscreen .chatbot-messages {
            height: calc(100vh - 280px) !important;
            max-height: calc(100vh - 280px) !important;
            overflow-y: scroll !important;
            flex: 1 1 auto !important;
        }
        
        .chatbot-window.fullscreen .quick-questions {
            max-height: 100px !important;
        }

        .chatbot-messages {
            flex: 1 1 auto;
            padding: 20px;
            overflow-y: scroll !important; /* Force scrollbar to always show */
            overflow-x: hidden;
            display: flex;
            flex-direction: column;
            gap: 15px;
            -webkit-overflow-scrolling: touch; /* Smooth scrolling on iOS */
            scroll-behavior: smooth;
            position: relative;
            min-height: 200px; /* Minimum height to ensure scrollbar is visible */
            max-height: 100%;
            height: 100%; /* Ensure full height usage */
            overscroll-behavior-y: contain; /* Prevent scroll chaining */
            -webkit-transform: translateZ(0); /* Hardware acceleration */
            transform: translateZ(0);
        }
        
        /* Force content area to be scrollable even with little content */
        .chatbot-messages::after {
            content: '';
            display: block;
            height: 1px; /* Minimal height to force scrollbar */
            flex-shrink: 0;
        }
        
        /* Enhanced scrollbar styling for better visibility */
        .chatbot-messages::-webkit-scrollbar {
            width: 10px; /* Increased width for better visibility */
        }
        
        .chatbot-messages::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.15); /* Slightly more visible track */
            border-radius: 5px;
            margin: 5px 0; /* Add some margin to the track */
        }
        
        .chatbot-messages::-webkit-scrollbar-thumb {
            background: rgba(255, 215, 0, 0.6); /* More visible thumb */
            border-radius: 5px;
            border: 2px solid rgba(0, 0, 0, 0.2); /* Add border for better definition */
            min-height: 30px; /* Minimum thumb height for visibility */
        }
        
        .chatbot-messages::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 215, 0, 0.8); /* Even more visible on hover */
            border-color: rgba(255, 215, 0, 0.3);
        }
        
        /* Firefox scrollbar styling */
        .chatbot-messages {
            scrollbar-width: auto; /* Changed from thin to auto for always visible */
            scrollbar-color: rgba(255, 215, 0, 0.6) rgba(255, 255, 255, 0.15); /* Firefox colors */
        }

        .message {
            max-width: 80%;
            padding: 12px 16px;
            border-radius: 18px;
            word-wrap: break-word;
            line-height: 1.4;
        }

        .message.user {
            background: linear-gradient(135deg, #FFD700, #FFA500);
            color: #000;
            align-self: flex-end;
            margin-left: auto;
        }

        .message.bot {
            background: rgba(255, 255, 255, 0.1);
            color: #fff;
            align-self: flex-start;
            border: 1px solid rgba(255, 215, 0, 0.3);
        }

        .message.thinking {
            background: rgba(255, 215, 0, 0.2);
            color: #FFD700;
            align-self: flex-start;
            border: 1px solid rgba(255, 215, 0, 0.5);
            font-style: italic;
        }

        .typing-indicator {
            display: flex;
            align-items: center;
            gap: 5px;
            color: #FFD700;
            font-style: italic;
        }

        .typing-dots {
            display: flex;
            gap: 3px;
        }

        .typing-dots span {
            width: 6px;
            height: 6px;
            background: #FFD700;
            border-radius: 50%;
            animation: typing 1.4s infinite ease-in-out;
        }

        .typing-dots span:nth-child(1) { animation-delay: -0.32s; }
        .typing-dots span:nth-child(2) { animation-delay: -0.16s; }

        @keyframes typing {
            0%, 80%, 100% { transform: scale(0); opacity: 0.5; }
            40% { transform: scale(1); opacity: 1; }
        }

        .chatbot-input-container {
            padding: 20px;
            border-top: 1px solid rgba(255, 215, 0, 0.3);
            display: flex;
            gap: 10px;
        }

        .chatbot-input {
            flex: 1;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 215, 0, 0.3);
            border-radius: 25px;
            padding: 12px 16px;
            color: #fff;
            font-size: 14px;
            outline: none;
        }

        .chatbot-input::placeholder {
            color: rgba(255, 255, 255, 0.6);
        }

        .chatbot-input:focus {
            border-color: #FFD700;
            box-shadow: 0 0 10px rgba(255, 215, 0, 0.3);
        }

        .chatbot-send {
            background: linear-gradient(135deg, #FFD700, #FFA500);
            border: none;
            border-radius: 50%;
            width: 45px;
            height: 45px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .chatbot-send:hover {
            transform: scale(1.1);
            box-shadow: 0 4px 15px rgba(255, 215, 0, 0.4);
        }

        .chatbot-send:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .chatbot-send svg {
            width: 20px;
            height: 20px;
            fill: #000;
        }

        .quick-questions {
            padding: 10px 20px;
            border-top: 1px solid rgba(255, 215, 0, 0.3);
        }

        .quick-questions h4 {
            color: #FFD700;
            font-size: 12px;
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .quick-question-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .quick-question-btn {
            background: rgba(255, 215, 0, 0.2);
            border: 1px solid rgba(255, 215, 0, 0.4);
            color: #FFD700;
            padding: 6px 12px;
            border-radius: 15px;
            font-size: 11px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .quick-question-btn:hover {
            background: rgba(255, 215, 0, 0.3);
            border-color: #FFD700;
        }

        @media (max-width: 768px) {
            .chatbot-window {
                width: 350px;
                height: 500px;
                max-height: 85vh; /* Prevent overflow on smaller screens */
            }
            
            .chatbot-messages {
                padding: 15px;
                flex: 1;
                min-height: 0; /* Allow flex shrinking */
                max-height: calc(100% - 240px); /* Account for header, input, and quick questions */
                overflow-y: scroll !important; /* Force scrollbar always visible on tablet */
            }
            
            .message {
                font-size: 14px;
                max-width: 90%;
            }
            
            /* Show expand button on tablet/mobile */
            .chatbot-expand {
                display: flex !important;
            }
        }

        @media (max-width: 480px) {
            .chatbot-container {
                bottom: 15px;
                right: 15px;
            }
            
            .chatbot-window {
                width: calc(100vw - 30px); /* Full width minus margins */
                height: 70vh; /* Use viewport height for better mobile experience */
                max-height: 600px;
                bottom: 70px;
                right: -15px; /* Adjust position for full width */
                display: flex;
                flex-direction: column;
            }
            
            .chatbot-messages {
                padding: 12px;
                flex: 1 1 auto;
                min-height: 0;
                height: calc(70vh - 350px); /* Fixed height for better scrolling */
                max-height: calc(70vh - 350px);
                overflow-y: scroll !important; /* Force scrollbar always visible */
                overflow-x: hidden;
                -webkit-overflow-scrolling: touch !important;
                touch-action: pan-y;
                position: relative;
                overscroll-behavior-y: contain;
                -webkit-transform: translateZ(0);
                transform: translateZ(0);
                scroll-behavior: smooth;
            }
            
            /* Force show expand button on mobile */
            .chatbot-expand {
                display: flex !important;
                visibility: visible !important;
                opacity: 1 !important;
            }
            
            .quick-questions {
                padding: 8px 12px;
                max-height: 120px;
                overflow-y: auto;
                -webkit-overflow-scrolling: touch;
            }
            
            .quick-question-buttons {
                gap: 6px;
            }
            
            .quick-question-btn {
                font-size: 10px;
                padding: 5px 10px;
            }
            
            .chatbot-input-container {
                padding: 12px;
            }
            
            .chatbot-input {
                font-size: 13px;
                padding: 10px 14px;
            }
            
            .chatbot-toggle {
                width: 50px;
                height: 50px;
            }
            
            .chatbot-toggle svg {
                width: 25px;
                height: 25px;
            }
            
            .message {
                font-size: 13px;
                padding: 10px 14px;
                max-width: 95%;
            }
            
            /* Ensure long messages are readable */
            .message.bot {
                word-break: break-word;
                white-space: pre-wrap;
            }
        }
        
        /* Additional mobile scroll improvements */
        @supports (-webkit-touch-callout: none) {
            /* iOS specific fixes */
            .chatbot-messages {
                -webkit-transform: translateZ(0);
                transform: translateZ(0);
            }
        }
    </style>
</head>
<body>
    <!-- Header with Wallet Connection -->
    <header class="header">
        <div class="header-logo">Jewel ICU</div>
        <div class="header-right">
            <div class="wallet-section" id="walletSection">
                <button class="wallet-button" id="connectWalletBtn">
                    <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M3 9V15C3 17.2091 4.79086 19 7 19H17C19.2091 19 21 17.2091 21 15V9C21 6.79086 19.2091 5 17 5H7C4.79086 5 3 6.79086 3 9Z" stroke="currentColor" stroke-width="2"/>
                        <path d="M7 9V7C7 4.79086 8.79086 3 11 3H13C15.2091 3 17 4.79086 17 7V9" stroke="currentColor" stroke-width="2"/>
                        <circle cx="12" cy="12" r="1" fill="currentColor"/>
                    </svg>
                    Connect Wallet
                </button>
            </div>
            <!-- Buy JEWEL Button via x402 (always visible) -->
            <button class="buy-button" id="buyJewelBtn">
                <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" width="18" height="18">
                    <path d="M6 2L3 6v14a2 2 0 002 2h14a2 2 0 002-2V6l-3-4z" stroke="currentColor" stroke-width="2" stroke-linejoin="round"/>
                    <line x1="3" y1="6" x2="21" y2="6" stroke="currentColor" stroke-width="2"/>
                    <path d="M16 10a4 4 0 01-8 0" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                </svg>
                Buy JEWEL
            </button>
            <!-- Airdrop Button (hidden by default) -->
            <button class="airdrop-button" id="airdropBtn" style="display: none;">
                <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M12 2L12 14" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                    <path d="M12 14L8 10" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                    <path d="M12 14L16 10" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                    <path d="M5 16C5 16 6.5 14 12 14C17.5 14 19 16 19 16" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                    <path d="M3 20C3 20 5 17 12 17C19 17 21 20 21 20" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                </svg>
                Claim Airdrop
            </button>
        </div>
    </header>

    <!-- Toast Container -->
    <div id="toastContainer"></div>

    <div class="container">
        <img src="Images/1000015202.png" alt="Jewel ICU Splash Screen" class="splash-image">
        <div class="overlay"></div>
        
        <div class="banner">
            <h1>JEWEL INTERNATIONAL CURRENCY UNIT</h1>
            <p>The Future of Digital Currency</p>
        </div>
        
        <div class="instructions">
            <h2>How to Buy Jewel ICU</h2>
            <div class="steps">
                <div class="step">
                    <h3>Step 1: Download Solflare Mobile App</h3>
                    <p>Download the Solflare wallet app from the Google Play Store:</p>
                    <a href="https://play.google.com/store/apps/details?id=com.solflare.mobile" target="_blank" class="app-link">
                        Download Solflare Mobile App
                    </a>
                </div>
                
                <div class="step">
                    <h3>Step 2: Download PumpFun Mobile App</h3>
                    <p>Download the PumpFun app from the Google Play Store:</p>
                    <a href="https://play.google.com/store/apps/details?id=com.batonresearch.pump" target="_blank" class="app-link">
                        Download PumpFun Mobile App
                    </a>
                </div>
                
                <div class="step">
                    <h3>Step 3: Buy Solana</h3>
                    <p>You can buy Solana (SOL) from your favorite crypto exchange:</p>
                    <ul style="color: #fff; margin: 10px 0; padding-left: 20px; line-height: 1.8;">
                        <li><strong>Centralized Exchanges (CEX):</strong> Binance, Coinbase, Kraken, KuCoin, Gate.io, Bybit, OKX</li>
                        <li><strong>Decentralized Exchanges (DEX):</strong> Jupiter, Raydium, Orca, Serum</li>
                        <li><strong>Direct in Solflare:</strong> Open the Solflare app and click the "Buy" button</li>
                    </ul>
                    <p style="margin-top: 10px;">After purchasing Solana from your preferred exchange, withdraw/transfer it to your Solflare wallet address.</p>
                </div>
                
                <div class="step">
                    <h3>Step 4: Transfer Solana to Pump.Fun</h3>
                    <p>Transfer your Solana to your Pump.Fun account address:</p>
                    <ol style="color: #fff; margin: 10px 0; padding-left: 20px; line-height: 1.8;">
                        <li>Open the PumpFun app and find your wallet address</li>
                        <li>Copy your Pump.Fun wallet address</li>
                        <li>Send your Solana from your exchange or Solflare wallet to this Pump.Fun address</li>
                    </ol>
                    <p style="margin-top: 10px; color: #FFD700;"><strong>Important:</strong> Make sure you're sending to the correct Pump.Fun address to avoid losing funds!</p>
                </div>
                
                <div class="step">
                    <h3>Step 5: Buy Jewel ICU</h3>
                    <p>Click the link below to go to the Jewel ICU buy page on Pump.fun:</p>
                    <a href="https://pump.fun/coin/37ApeZ2X8dwKZkV22wDqLzDFh4QRkTMSvkc3uau6pump" target="_blank" class="buy-link">
                        Buy Jewel ICU on Pump.fun
                    </a>
                    <p>Complete your purchase of Jewel ICU coins!</p>
                </div>
            </div>
        </div>
        
        <div class="footer">
            <p>&copy; 2025 Jewel ICU - Revolutionizing Global Finance</p>
        </div>
    </div>

    <!-- Chatbot -->
    <div class="chatbot-container">
        <button class="chatbot-toggle" id="chatbotToggle">
            <svg viewBox="0 0 24 24">
                <path d="M20 2H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h4l4 4 4-4h4c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm-2 12H6v-2h12v2zm0-3H6V9h12v2zm0-3H6V6h12v2z"/>
            </svg>
        </button>
        
        <div class="chatbot-window" id="chatbotWindow">
            <div class="chatbot-header">
                <span>Jewel ICU Assistant</span>
                <div class="chatbot-header-controls">
                    <button class="chatbot-expand" id="chatbotExpand" title="Expand/Collapse" style="display: none;">â¬š</button>
                    <button class="chatbot-close" id="chatbotClose">Ã—</button>
                </div>
            </div>
            
            <div class="chatbot-messages" id="chatbotMessages">
                <div class="message bot">
                    <strong style="color: #FFD700; font-size: 16px; display: block; margin-bottom: 10px; text-transform: uppercase;">
                        ðŸ“± Pinch and reduce the screen on mobile for chat scrolling to work
                    </strong>
                    Hi! I'm your Jewel ICU assistant. I can help you with:
                    <br>â€¢ Setting up Solflare wallet
                    <br>â€¢ Connecting Phantom wallet on mobile
                    <br>â€¢ Securing your 12-word seed phrase
                    <br>â€¢ Funding PumpFun with Solana
                    <br>â€¢ Purchasing Jewel ICU coins
                    <br>â€¢ Understanding the graduation process
                    <br><br>What would you like to know?
                </div>
            </div>
            
            <div class="quick-questions">
                <h4>Quick Questions</h4>
                <div class="quick-question-buttons">
                    <button class="quick-question-btn" data-question="How do I set up a Solflare wallet?">Setup Wallet</button>
                    <button class="quick-question-btn" data-question="How do I secure my seed phrase?">Secure Phrase</button>
                    <button class="quick-question-btn" data-question="How do I fund PumpFun?">Fund PumpFun</button>
                    <button class="quick-question-btn" data-question="How do I buy Jewel ICU?">Buy Jewel ICU</button>
                    <button class="quick-question-btn" data-question="What is graduation?">Graduation</button>
                    <button class="quick-question-btn" data-question="How do I connect Phantom wallet on mobile to Jewel.icu?">Connect Phantom</button>
                </div>
            </div>
            
            <div class="chatbot-input-container">
                <input type="text" class="chatbot-input" id="chatbotInput" placeholder="Ask me anything about Jewel ICU...">
                <button class="chatbot-send" id="chatbotSend">
                    <svg viewBox="0 0 24 24">
                        <path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/>
                    </svg>
                </button>
            </div>
        </div>
    </div>

    <script>
        // Wallet Connection Class
        class SolflareWalletConnection {
            constructor() {
                this.connected = false;
                this.publicKey = null;
                this.provider = null;
                this.walletType = null;
                
                this.initializeElements();
                this.detectEnvironment();
                this.checkSolflareInstalled();
                this.attachEventListeners();
                this.checkPreviousConnection();
            }

            detectEnvironment() {
                // Check if we're in Solflare's in-app browser
                const userAgent = navigator.userAgent || navigator.vendor || window.opera;
                this.isInSolflareApp = userAgent.includes('Solflare');
                
                // Check if we're on mobile
                this.isMobileDevice = this.isMobile();
            }

            initializeElements() {
                this.connectBtn = document.getElementById('connectWalletBtn');
                this.walletSection = document.getElementById('walletSection');
            }

            checkSolflareInstalled() {
                // 1. Solflare in-app browser (mobile app)
                if (this.isInSolflareApp && window.solana) {
                    console.log('Detected Solflare in-app browser');
                    this.provider = window.solana;
                    this.walletType = 'in-app';
                    if (window.solana.isConnected && window.solana.publicKey) {
                        console.log('Already connected in Solflare app:', window.solana.publicKey.toString());
                        setTimeout(() => {
                            this.handleConnection(window.solana.publicKey.toString());
                        }, 500);
                    }
                    return true;
                }

                // 2. Solflare Chrome extension (highest priority on desktop)
                if (window.solflare && window.solflare.isSolflare) {
                    console.log('Detected Solflare extension');
                    this.provider = window.solflare;
                    this.walletType = 'extension';
                    if (window.solflare.isConnected && window.solflare.publicKey) {
                        setTimeout(() => {
                            this.handleConnection(window.solflare.publicKey.toString());
                        }, 500);
                    }
                    return true;
                }

                // 3. window.solana â€” Solflare also injects this; Phantom does too
                if (window.solana) {
                    console.log('Found window.solana:', window.solana.isSolflare ? 'Solflare' : 'Other');
                    this.provider = window.solana;
                    this.walletType = 'solana';
                    if (window.solana.isConnected && window.solana.publicKey) {
                        console.log('Already connected:', window.solana.publicKey.toString());
                        setTimeout(() => {
                            this.handleConnection(window.solana.publicKey.toString());
                        }, 500);
                    }
                    return true;
                }

                // 4. Phantom as fallback
                if (window.phantom && window.phantom.solana) {
                    console.log('Detected Phantom wallet');
                    this.provider = window.phantom.solana;
                    this.walletType = 'phantom';
                    return true;
                }

                // 5. Mobile deep-link fallback
                if (this.isMobileDevice) {
                    this.walletType = 'mobile';
                    return 'mobile';
                }

                return false;
            }

            isMobile() {
                return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
            }

            attachEventListeners() {
                this.connectBtn.addEventListener('click', () => this.connectWallet());
                
                // Listen for account changes
                if (this.provider) {
                    this.provider.on('accountChanged', (publicKey) => {
                        if (publicKey) {
                            this.handleConnection(publicKey.toString());
                        } else {
                            this.handleDisconnection();
                        }
                    });
                }
            }

            async checkPreviousConnection() {
                // Check if wallet was previously connected
                const previouslyConnected = localStorage.getItem('solflareConnected');
                if (previouslyConnected === 'true' && this.provider) {
                    try {
                        const response = await this.provider.connect({ onlyIfTrusted: true });
                        if (response.publicKey) {
                            this.handleConnection(response.publicKey.toString());
                        }
                    } catch (err) {
                        // Silent fail - user hasn't pre-approved
                    }
                }
            }

            async connectWallet() {
                const solflareStatus = this.checkSolflareInstalled();
                
                // Handle mobile wallet connection
                if (solflareStatus === 'mobile') {
                    this.connectMobileWallet();
                    return;
                }
                
                // Handle desktop - no extension installed
                if (!solflareStatus) {
                    this.showWalletSelectionModal();
                    return;
                }

                // Desktop extension connection
                try {
                    this.connectBtn.disabled = true;
                    this.connectBtn.innerHTML = `
                        <svg class="animate-spin" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2" opacity="0.25"/>
                            <path d="M12 2C6.48 2 2 6.48 2 12" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                        </svg>
                        Connecting...
                    `;

                    const response = await this.provider.connect();
                    console.log('Connection response:', response);
                    
                    if (response && response.publicKey) {
                        const pubKeyString = response.publicKey.toString();
                        console.log('Public key received:', pubKeyString);
                        this.handleConnection(pubKeyString);
                        localStorage.setItem('solflareConnected', 'true');
                        this.showToast('Wallet connected successfully!', 'success');
                    } else if (this.provider.publicKey) {
                        // Sometimes the publicKey is directly on the provider
                        const pubKeyString = this.provider.publicKey.toString();
                        console.log('Public key from provider:', pubKeyString);
                        this.handleConnection(pubKeyString);
                        localStorage.setItem('solflareConnected', 'true');
                        this.showToast('Wallet connected successfully!', 'success');
                    } else {
                        console.error('No public key in response:', response);
                        this.showToast('Connected but no public key received', 'error');
                    }
                } catch (err) {
                    console.error('Connection error:', err);
                    this.showToast('Failed to connect wallet. Please try again.', 'error');
                } finally {
                    if (!this.connected) {
                        this.connectBtn.disabled = false;
                        this.updateButtonState();
                    }
                }
            }

            handleConnection(publicKey) {
                console.log('Handling connection with public key:', publicKey);
                
                // Prevent duplicate updates
                if (this.connected && this.publicKey === publicKey) {
                    return;
                }
                
                this.connected = true;
                this.publicKey = publicKey;
                
                // Clear the polling interval
                if (this.checkConnectionInterval) {
                    clearInterval(this.checkConnectionInterval);
                    this.checkConnectionInterval = null;
                }
                
                // Force UI update
                requestAnimationFrame(() => {
                    this.updateWalletUI();
                    
                    // Double-check the UI updated
                    setTimeout(() => {
                        if (!document.querySelector('.wallet-connected')) {
                            console.log('UI update failed, trying again...');
                            this.updateWalletUI();
                        }
                    }, 100);
                });
            }

            handleDisconnection() {
                this.connected = false;
                this.publicKey = null;
                localStorage.removeItem('solflareConnected');
                this.updateWalletUI();
                this.showToast('Wallet disconnected', 'info');
                
                // Restart polling
                if (!this.checkConnectionInterval) {
                    this.checkConnectionInterval = setInterval(() => {
                        this.checkCurrentConnection();
                    }, 2000);
                }
            }

            async disconnectWallet() {
                try {
                    if (this.provider && this.provider.disconnect) {
                        await this.provider.disconnect();
                    }
                    this.handleDisconnection();
                } catch (err) {
                    console.error('Disconnect error:', err);
                    this.handleDisconnection();
                }
            }

            updateWalletUI() {
                console.log('Updating wallet UI. Connected:', this.connected, 'PublicKey:', this.publicKey);
                
                // Ensure we have the wallet section element
                if (!this.walletSection) {
                    this.walletSection = document.getElementById('walletSection');
                }
                
                if (this.connected && this.publicKey) {
                    const truncatedAddress = this.truncateAddress(this.publicKey);
                    this.walletSection.innerHTML = `
                        <div class="wallet-connected">
                            <span class="wallet-address">${truncatedAddress}</span>
                            <button class="disconnect-button" onclick="walletConnection.disconnectWallet()">
                                Disconnect
                            </button>
                        </div>
                    `;
                    // Show airdrop button when wallet is connected
                    const airdropBtn = document.getElementById('airdropBtn');
                    if (airdropBtn) {
                        airdropBtn.style.display = 'flex';
                    }
                } else {
                    this.walletSection.innerHTML = `
                        <button class="wallet-button" id="connectWalletBtn">
                            <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path d="M3 9V15C3 17.2091 4.79086 19 7 19H17C19.2091 19 21 17.2091 21 15V9C21 6.79086 19.2091 5 17 5H7C4.79086 5 3 6.79086 3 9Z" stroke="currentColor" stroke-width="2"/>
                                <path d="M7 9V7C7 4.79086 8.79086 3 11 3H13C15.2091 3 17 4.79086 17 7V9" stroke="currentColor" stroke-width="2"/>
                                <circle cx="12" cy="12" r="1" fill="currentColor"/>
                            </svg>
                            Connect Wallet
                        </button>
                    `;
                    // Hide airdrop button when wallet is disconnected
                    const airdropBtn = document.getElementById('airdropBtn');
                    if (airdropBtn) {
                        airdropBtn.style.display = 'none';
                    }
                    this.initializeElements();
                    this.attachEventListeners();
                }
            }

            updateButtonState() {
                if (!this.connected && this.connectBtn) {
                    this.connectBtn.innerHTML = `
                        <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M3 9V15C3 17.2091 4.79086 19 7 19H17C19.2091 19 21 17.2091 21 15V9C21 6.79086 19.2091 5 17 5H7C4.79086 5 3 6.79086 3 9Z" stroke="currentColor" stroke-width="2"/>
                            <path d="M7 9V7C7 4.79086 8.79086 3 11 3H13C15.2091 3 17 4.79086 17 7V9" stroke="currentColor" stroke-width="2"/>
                            <circle cx="12" cy="12" r="1" fill="currentColor"/>
                        </svg>
                        Connect Wallet
                    `;
                }
            }

            truncateAddress(address) {
                return `${address.slice(0, 4)}...${address.slice(-4)}`;
            }

            async connectMobileWallet() {
                try {
                    // Show clear instructions for mobile users
                    this.showMobileInstructions();
                } catch (err) {
                    console.error('Mobile connection error:', err);
                    this.showToast('Failed to show mobile instructions', 'error');
                }
            }

            showMobileInstructions() {
                // Create a modal with instructions
                const modal = document.createElement('div');
                modal.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    right: 0;
                    bottom: 0;
                    background: rgba(0, 0, 0, 0.9);
                    z-index: 3000;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    padding: 20px;
                `;
                
                modal.innerHTML = `
                    <div style="background: #1a1a1a; border: 2px solid #FFD700; border-radius: 15px; padding: 30px; max-width: 400px; width: 100%; text-align: center;">
                        <h2 style="color: #FFD700; margin-bottom: 20px;">Connect Solflare on Mobile</h2>
                        
                        <div style="color: #fff; margin-bottom: 25px; text-align: left;">
                            <p style="margin-bottom: 15px;"><strong>To connect your wallet:</strong></p>
                            <ol style="margin-left: 20px; line-height: 1.8;">
                                <li>Open the <strong>Solflare app</strong></li>
                                <li>Tap the <strong>browser icon</strong> (ðŸŒ) at the bottom</li>
                                <li>Enter this website URL or scan QR code</li>
                                <li>Click "Connect Wallet" again</li>
                            </ol>
                        </div>
                        
                        <div style="margin-bottom: 20px;">
                            <p style="color: #FFD700; margin-bottom: 10px;">Current URL:</p>
                            <div style="background: rgba(255, 215, 0, 0.1); padding: 10px; border-radius: 8px; word-break: break-all; font-size: 12px; color: #fff;">
                                ${window.location.href}
                            </div>
                        </div>
                        
                        <div style="display: flex; gap: 10px; justify-content: center;">
                            <button onclick="this.parentElement.parentElement.parentElement.remove()" style="background: #666; color: #fff; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer;">
                                Close
                            </button>
                            <button onclick="window.walletConnection.openSolflareApp()" style="background: linear-gradient(135deg, #FFD700, #FFA500); color: #000; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer; font-weight: bold;">
                                Open Solflare App
                            </button>
                        </div>
                        
                        <p style="color: #999; font-size: 12px; margin-top: 20px;">
                            Don't have Solflare?
                            <a href="#" onclick="window.walletConnection.offerAppDownload(); return false;" style="color: #FFD700;">Download here</a>
                        </p>
                    </div>
                `;
                
                document.body.appendChild(modal);
                
                // Close modal on background click
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        modal.remove();
                    }
                });
            }

            openSolflareApp() {
                const currentUrl = window.location.href;
                // Use the browser deep link to open this page in Solflare's browser
                const deepLink = `solflare://browser/${encodeURIComponent(currentUrl)}`;
                
                // Close the modal
                const modal = document.querySelector('[style*="z-index: 3000"]');
                if (modal) modal.remove();
                
                this.showToast('Opening Solflare app...', 'info');
                
                // Try to open the app
                window.location.href = deepLink;
                
                // Fallback after delay
                setTimeout(() => {
                    if (!this.connected) {
                        this.offerAppDownload();
                    }
                }, 3000);
            }

            offerAppDownload() {
                const downloadApp = confirm(
                    'Solflare app not detected.\n\n' +
                    'To use Solflare on mobile:\n' +
                    '1. Download the Solflare app\n' +
                    '2. Open this website in the app\'s browser\n\n' +
                    'Would you like to download Solflare now?'
                );
                
                if (downloadApp) {
                    const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
                    if (isIOS) {
                        window.open('https://apps.apple.com/app/solflare/id1580902717', '_blank');
                    } else {
                        window.open('https://play.google.com/store/apps/details?id=com.solflare.mobile', '_blank');
                    }
                }
            }

            setupMobileConnectionListener() {
                // Listen for connection data from Solflare mobile app
                window.addEventListener('message', (event) => {
                    if (event.data && event.data.type === 'solflare_connected') {
                        const publicKey = event.data.publicKey;
                        if (publicKey) {
                            this.handleConnection(publicKey);
                            this.showToast('Connected via Solflare app!', 'success');
                        }
                    }
                });
            }

            showWalletSelectionModal() {
                // Create modal for wallet selection
                const modal = document.createElement('div');
                modal.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    right: 0;
                    bottom: 0;
                    background: rgba(0, 0, 0, 0.9);
                    z-index: 3000;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    padding: 20px;
                `;
                
                modal.innerHTML = `
                    <div style="background: #1a1a1a; border: 2px solid #FFD700; border-radius: 15px; padding: 30px; max-width: 400px; width: 100%; text-align: center;">
                        <h2 style="color: #FFD700; margin-bottom: 20px;">No Wallet Detected</h2>
                        
                        <p style="color: #fff; margin-bottom: 20px;">
                            Solflare extension was not detected. You can:
                        </p>
                        
                        <div style="text-align: left; margin-bottom: 20px;">
                            <div style="background: rgba(255, 215, 0, 0.1); padding: 15px; border-radius: 8px; margin-bottom: 10px;">
                                <strong style="color: #FFD700;">Option 1: Install Solflare</strong>
                                <p style="margin: 5px 0 0 0; font-size: 14px; color: #ccc;">
                                    Download the Solflare browser extension
                                </p>
                            </div>
                            
                            <div style="background: rgba(255, 215, 0, 0.1); padding: 15px; border-radius: 8px;">
                                <strong style="color: #FFD700;">Option 2: Use Another Wallet</strong>
                                <p style="margin: 5px 0 0 0; font-size: 14px; color: #ccc;">
                                    Connect with Phantom or other Solana wallets
                                </p>
                            </div>
                        </div>
                        
                        <div style="display: flex; gap: 10px; justify-content: center;">
                            <button onclick="this.parentElement.parentElement.parentElement.remove()" style="background: #666; color: #fff; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer;">
                                Cancel
                            </button>
                            <button onclick="window.open('https://solflare.com', '_blank'); this.parentElement.parentElement.parentElement.remove();" style="background: linear-gradient(135deg, #FFD700, #FFA500); color: #000; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer; font-weight: bold;">
                                Get Solflare
                            </button>
                        </div>
                        
                        <p style="color: #999; font-size: 12px; margin-top: 20px;">
                            Note: After installing, refresh this page to connect
                        </p>
                    </div>
                `;
                
                document.body.appendChild(modal);
                
                // Close modal on background click
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        modal.remove();
                    }
                });
            }

            showToast(message, type = 'info') {
                const toast = document.createElement('div');
                toast.className = `toast ${type}`;
                toast.textContent = message;
                
                const container = document.getElementById('toastContainer');
                container.appendChild(toast);
                
                // Trigger animation
                setTimeout(() => toast.classList.add('show'), 10);
                
                // Remove after 3 seconds
                setTimeout(() => {
                    toast.classList.remove('show');
                    setTimeout(() => toast.remove(), 300);
                }, 3000);
            }
        }

        // Add spinning animation CSS
        const style = document.createElement('style');
        style.textContent = `
            @keyframes spin {
                from { transform: rotate(0deg); }
                to { transform: rotate(360deg); }
            }
            .animate-spin {
                animation: spin 1s linear infinite;
            }
        `;
        document.head.appendChild(style);

        // Initialize wallet connection
        let walletConnection;

        // Production Airdrop Configuration
        const AIRDROP_API_URL = 'https://jewel-icu-airdrop-production-561b.up.railway.app'; // Railway production API URL
        const RECAPTCHA_SITE_KEY = 'YOUR_RECAPTCHA_SITE_KEY'; // Optional - add your reCAPTCHA key when ready

        // Airdrop functionality
        class JewelAirdrop {
            constructor() {
                this.JEWEL_ICU_MINT = '37ApeZ2X8dwKZkV22wDqLzDFh4QRkTMSvkc3uau6pump';
                this.airdropBtn = document.getElementById('airdropBtn');
                this.isProcessing = false;
                this.attachEventListeners();
                
                // Check airdrop status on load
                this.checkAirdropStatus();
            }

            attachEventListeners() {
                if (this.airdropBtn) {
                    this.airdropBtn.addEventListener('click', () => this.handleAirdrop());
                }
                
                // Listen for wallet connection changes
                window.addEventListener('walletConnected', () => this.checkAirdropStatus());
                window.addEventListener('walletDisconnected', () => this.hideAirdropButton());
            }
            
            async checkAirdropStatus() {
                if (!walletConnection || !walletConnection.connected) return;
                
                try {
                    const walletAddress = walletConnection.provider.publicKey.toString();
                    const response = await fetch(`${AIRDROP_API_URL}/api/airdrop/status/${walletAddress}`);
                    const data = await response.json();
                    
                    if (data.claimed) {
                        this.showAlreadyClaimed(data);
                    } else {
                        this.showAirdropButton();
                    }
                } catch (error) {
                    console.error('Error checking airdrop status:', error);
                    this.showAirdropButton(); // Show button on error
                }
            }
            
            showAirdropButton() {
                if (this.airdropBtn) {
                    this.airdropBtn.style.display = 'flex';
                    this.airdropBtn.disabled = false;
                }
            }
            
            hideAirdropButton() {
                if (this.airdropBtn) {
                    this.airdropBtn.style.display = 'none';
                }
            }
            
            showAlreadyClaimed(claimData) {
                if (this.airdropBtn) {
                    this.airdropBtn.style.display = 'flex';
                    this.airdropBtn.disabled = true;
                    this.airdropBtn.innerHTML = `
                        <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M9 12l2 2 4-4" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2"/>
                        </svg>
                        Already Claimed
                    `;
                    
                    // Add status text
                    const statusDiv = document.createElement('div');
                    statusDiv.className = 'airdrop-status airdrop-success';
                    statusDiv.textContent = `Claimed on ${new Date(claimData.claimedAt).toLocaleDateString()}`;
                    this.airdropBtn.parentNode.appendChild(statusDiv);
                    
                    if (claimData.transactionSignature) {
                        const txLink = document.createElement('a');
                        txLink.href = `https://solscan.io/tx/${claimData.transactionSignature}`;
                        txLink.target = '_blank';
                        txLink.className = 'transaction-link';
                        txLink.textContent = 'View Transaction';
                        this.airdropBtn.parentNode.appendChild(txLink);
                    }
                }
            }

            async handleAirdrop() {
                if (this.isProcessing) return;
                
                if (!walletConnection || !walletConnection.connected) {
                    walletConnection.showToast('Please connect your wallet first', 'error');
                    return;
                }

                this.isProcessing = true;
                this.setButtonLoading(true);

                try {
                    // Get reCAPTCHA token
                    const captchaToken = await this.getCaptchaToken();
                    
                    // Get wallet signature for verification (optional but recommended)
                    const signature = await this.getWalletSignature();
                    
                    // Build payload without null fields to satisfy backend validators
                    const payload = { walletAddress: walletConnection.provider.publicKey.toString() };
                    if (captchaToken) payload.captchaToken = captchaToken;
                    if (signature)    payload.signature    = signature;

                    // Call production API
                    const response = await fetch(`${AIRDROP_API_URL}/api/airdrop/claim`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(payload)
                    });

                    const data = await response.json();
                    
                    if (response.ok) {
                        walletConnection.showToast('ðŸŽ‰ Airdrop successful! Check your wallet.', 'success');
                        
                        // Show transaction link
                        if (data.transactionSignature) {
                            const txUrl = `https://solscan.io/tx/${data.transactionSignature}`;
                            console.log('Transaction:', txUrl);
                            
                            // Update button to show claimed status
                            this.showAlreadyClaimed({
                                claimedAt: new Date().toISOString(),
                                transactionSignature: data.transactionSignature
                            });
                        }
                    } else {
                        // Handle specific error cases
                        if (response.status === 429) {
                            walletConnection.showToast('Too many requests. Please try again later.', 'error');
                        } else if (response.status === 400 && data.error.includes('already claimed')) {
                            walletConnection.showToast('You have already claimed your airdrop.', 'info');
                            this.checkAirdropStatus(); // Refresh status
                        } else {
                            walletConnection.showToast(data.error || 'Airdrop failed. Please try again.', 'error');
                        }
                    }
                } catch (error) {
                    console.error('Airdrop error:', error);
                    walletConnection.showToast('Network error. Please check your connection and try again.', 'error');
                } finally {
                    this.setButtonLoading(false);
                    this.isProcessing = false;
                }
            }
            
            async getCaptchaToken() {
                try {
                    // Only try if reCAPTCHA is loaded and site key is configured
                    if (typeof grecaptcha !== 'undefined' && RECAPTCHA_SITE_KEY !== 'YOUR_RECAPTCHA_SITE_KEY') {
                        return await grecaptcha.execute(RECAPTCHA_SITE_KEY, { action: 'claim_airdrop' });
                    }
                    return null; // Continue without CAPTCHA if not configured
                } catch (error) {
                    console.error('CAPTCHA error:', error);
                    return null; // Continue without CAPTCHA if it fails
                }
            }
            
            async getWalletSignature() {
                try {
                    const message = JSON.stringify({
                        action: 'claim_airdrop',
                        timestamp: Date.now(),
                        nonce: this.generateNonce()
                    });
                    
                    const encodedMessage = new TextEncoder().encode(message);
                    const signature = await walletConnection.provider.signMessage(encodedMessage);
                    
                    return {
                        message: message,
                        signature: bs58.encode(signature),
                        publicKey: walletConnection.provider.publicKey.toString()
                    };
                } catch (error) {
                    console.error('Signature error:', error);
                    return null; // Continue without signature if user rejects
                }
            }
            
            generateNonce() {
                return Array.from(crypto.getRandomValues(new Uint8Array(16)))
                    .map(b => b.toString(16).padStart(2, '0'))
                    .join('');
            }

            setButtonLoading(loading) {
                if (!this.airdropBtn) return;
                
                if (loading) {
                    this.airdropBtn.classList.add('loading');
                    this.airdropBtn.disabled = true;
                    this.airdropBtn.innerHTML = `
                        <svg class="animate-spin" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2" opacity="0.25"/>
                            <path d="M12 2C6.48 2 2 6.48 2 12" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                        </svg>
                        Processing...
                    `;
                } else {
                    this.airdropBtn.classList.remove('loading');
                    this.airdropBtn.disabled = false;
                    this.airdropBtn.innerHTML = `
                        <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M12 2L12 14" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                            <path d="M12 14L8 10" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                            <path d="M12 14L16 10" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                            <path d="M5 16C5 16 6.5 14 12 14C17.5 14 19 16 19 16" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                            <path d="M3 20C3 20 5 17 12 17C19 17 21 20 21 20" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                        </svg>
                        Claim Airdrop
                    `;
                }
            }
        }

        class JewelICUChatbot {
            constructor() {
                this.apiKey = '';
                this.isOpen = false;
                this.isThinking = false;
                this.conversationHistory = [];
                
                this.initializeElements();
                this.attachEventListeners();
                this.initializeKnowledgeBase();
            }

            initializeElements() {
                this.toggle = document.getElementById('chatbotToggle');
                this.window = document.getElementById('chatbotWindow');
                this.close = document.getElementById('chatbotClose');
                this.expand = document.getElementById('chatbotExpand');
                this.messages = document.getElementById('chatbotMessages');
                this.input = document.getElementById('chatbotInput');
                this.send = document.getElementById('chatbotSend');
                this.quickButtons = document.querySelectorAll('.quick-question-btn');
                this.isFullscreen = false;
            }

            attachEventListeners() {
                this.toggle.addEventListener('click', () => this.toggleChat());
                this.close.addEventListener('click', () => this.closeChat());
                if (this.expand) {
                    this.expand.addEventListener('click', () => this.toggleFullscreen());
                }
                this.send.addEventListener('click', () => this.sendMessage());
                this.input.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') this.sendMessage();
                });
                
                this.quickButtons.forEach(btn => {
                    btn.addEventListener('click', () => {
                        const question = btn.getAttribute('data-question');
                        this.input.value = question;
                        this.sendMessage();
                    });
                });
                
                // Improve mobile scrolling
                if ('ontouchstart' in window) {
                    let scrolling = false;
                    
                    this.messages.addEventListener('touchstart', (e) => {
                        scrolling = true;
                    }, { passive: true });
                    
                    this.messages.addEventListener('touchmove', (e) => {
                        if (!scrolling) return;
                        e.stopPropagation();
                    }, { passive: true });
                    
                    this.messages.addEventListener('touchend', () => {
                        scrolling = false;
                    }, { passive: true });
                }
            }
            
            toggleFullscreen() {
                this.isFullscreen = !this.isFullscreen;
                this.window.classList.toggle('fullscreen', this.isFullscreen);
                
                // Update expand button icon
                if (this.expand) {
                    this.expand.innerHTML = this.isFullscreen ? 'â¬œ' : 'â¬š';
                    this.expand.title = this.isFullscreen ? 'Exit Fullscreen' : 'Enter Fullscreen';
                }
                
                // Ensure messages scroll to bottom after resize
                setTimeout(() => {
                    this.messages.scrollTop = this.messages.scrollHeight;
                }, 100);
            }

            initializeKnowledgeBase() {
                this.knowledgeBase = {
                    solflareSetup: `
                        **Setting up Solflare Wallet:**
                        
                        1. **Download the App**: Get Solflare from Google Play Store or Apple App Store
                        2. **Create New Wallet**: Tap "Create a new wallet"
                        3. **Set Password**: Choose a strong password for your wallet
                        4. **Backup Seed Phrase**: Write down your 12-word recovery phrase
                        5. **Verify Phrase**: Confirm your seed phrase by selecting words in order
                        6. **Enable Security**: Set up biometric authentication if available
                        
                        **Important**: Never share your seed phrase with anyone!
                    `,
                    
                    seedPhraseSecurity: `
                        **Securing Your 12-Word Seed Phrase:**
                        
                        ðŸ” **Critical Security Steps:**
                        1. **Write it Down**: Use pen and paper, never digital storage
                        2. **Multiple Copies**: Create 2-3 physical copies
                        3. **Secure Storage**: Use a safe, safety deposit box, or fireproof container
                        4. **Never Share**: Don't tell anyone or store online
                        5. **Test Recovery**: Verify you can restore wallet with phrase
                        6. **Metal Backup**: Consider engraving on metal for fire/water protection
                        
                        âš ï¸ **Never Do:**
                        - Screenshot or photo the phrase
                        - Store in cloud services
                        - Share via text/email
                        - Enter on suspicious websites
                        
                        **Remember**: Your seed phrase = complete wallet access!
                    `,
                    
                    pumpfunFunding: `
                        **Funding PumpFun with Solana:**
                        
                        1. **Get Solana in Solflare**:
                           - Open Solflare wallet
                           - Tap "Buy" button
                           - Purchase SOL using credit card or bank transfer
                        
                        2. **Find Your PumpFun Address**:
                           - Open PumpFun app
                           - Go to wallet section
                           - Copy your Solana wallet address
                        
                        3. **Transfer SOL**:
                           - In Solflare, tap "Send"
                           - Paste PumpFun wallet address
                           - Enter amount (leave some SOL for fees)
                           - Confirm transaction
                        
                        4. **Verify Transfer**:
                           - Check PumpFun wallet balance
                           - Usually takes 1-2 minutes
                        
                        **Tip**: Always send a small test amount first!
                    `,
                    
                    jewelicuPurchase: `
                        **Purchasing Jewel ICU Coins:**
                        
                        1. **Ensure SOL Balance**: Have Solana in your PumpFun wallet
                        
                        2. **Visit Jewel ICU Page**:
                           - Go to: https://pump.fun/coin/37ApeZ2X8dwKZkV22wDqLzDFh4QRkTMSvkc3uau6pump
                           - Or search "Jewel ICU" on Pump.fun
                        
                        3. **Connect Wallet**: Link your Solana wallet to PumpFun
                        
                        4. **Set Purchase Amount**:
                           - Enter SOL amount to spend
                           - Review Jewel ICU tokens you'll receive
                        
                        5. **Execute Trade**:
                           - Click "Buy"
                           - Confirm transaction in wallet
                           - Wait for confirmation
                        
                        6. **Verify Purchase**: Check your wallet for Jewel ICU tokens
                        
                        **Current Status**: Jewel ICU is in pre-graduation phase on Pump.fun
                    `,
                    
                    graduation: `
                        **Jewel ICU Graduation Process:**
                        
                        **What is Graduation?**
                        - Transition from Pump.fun to major exchanges (Raydium, Jupiter)
                        - Requires reaching market cap milestone
                        - Creates permanent liquidity pool
                        
                        **Graduation Requirements:**
                        - Market cap must reach $69,000 USD
                        - Sufficient trading volume
                        - Community engagement metrics
                        
                        **Benefits of Graduation:**
                        âœ… **Increased Liquidity**: Easier buying/selling
                        âœ… **Major Exchange Listings**: Available on DEXs like Raydium
                        âœ… **Price Stability**: More stable price movements
                        âœ… **Wider Accessibility**: More platforms to trade
                        âœ… **Institutional Interest**: Attracts larger investors
                        âœ… **Long-term Viability**: Permanent market presence
                        
                        **Current Progress**: Track graduation progress on the Pump.fun page
                        
                        **Investment Tip**: Early supporters before graduation often see significant returns!
                    `,
                    
                    phantomConnection: `
                        **Connecting Phantom Wallet on Mobile to Jewel.icu:**
                        
                        ðŸ“± **For Phantom Mobile App:**
                        
                        1. **Open Phantom App**: Launch the Phantom wallet app on your mobile device
                        
                        2. **Use In-App Browser**:
                           - Tap the browser icon (ðŸŒ) at the bottom of the app
                           - Navigate to: https://jewel.icu
                           - The site will automatically detect Phantom
                        
                        3. **Connect Wallet**:
                           - Click "Connect Wallet" button on Jewel.icu
                           - Phantom will prompt for connection approval
                           - Tap "Connect" to approve
                        
                        4. **Verify Connection**:
                           - Your wallet address will appear in the header
                           - You can now interact with all site features
                        
                        ðŸ”— **Alternative: WalletConnect (if supported)**:
                        1. Open Jewel.icu in your regular mobile browser
                        2. Click "Connect Wallet"
                        3. Select "WalletConnect" option
                        4. Scan QR code with Phantom app
                        
                        âš ï¸ **Important Tips:**
                        - Always use Phantom's in-app browser for best compatibility
                        - Never enter your seed phrase on any website
                        - Check the URL is exactly: https://jewel.icu
                        - Enable biometric authentication for security
                        
                        **Troubleshooting:**
                        - If connection fails, refresh the page
                        - Clear browser cache in Phantom settings
                        - Update Phantom app to latest version
                        - Ensure you have some SOL for transaction fees
                    `
                };
            }

            toggleChat() {
                this.isOpen = !this.isOpen;
                this.window.classList.toggle('active', this.isOpen);
                if (this.isOpen) {
                    this.input.focus();
                    // Show expand button on mobile when chat opens
                    if (window.innerWidth <= 768 && this.expand) {
                        this.expand.style.display = 'flex';
                    }
                }
            }

            closeChat() {
                this.isOpen = false;
                this.isFullscreen = false;
                this.window.classList.remove('active', 'fullscreen');
                if (this.expand) {
                    this.expand.style.transform = 'rotate(0deg)';
                }
            }

            async sendMessage() {
                const message = this.input.value.trim();
                if (!message || this.isThinking) return;

                this.addMessage(message, 'user');
                this.input.value = '';
                this.send.disabled = true;

                await this.processMessage(message);
                this.send.disabled = false;
            }

            addMessage(content, type) {
                const messageDiv = document.createElement('div');
                messageDiv.className = `message ${type}`;
                messageDiv.innerHTML = content.replace(/\n/g, '<br>');
                this.messages.appendChild(messageDiv);
                this.messages.scrollTop = this.messages.scrollHeight;
            }

            showThinking(thought) {
                const thinkingDiv = document.createElement('div');
                thinkingDiv.className = 'message thinking';
                thinkingDiv.innerHTML = `ðŸ¤” ${thought}`;
                this.messages.appendChild(thinkingDiv);
                this.messages.scrollTop = this.messages.scrollHeight;
                return thinkingDiv;
            }

            showTyping() {
                const typingDiv = document.createElement('div');
                typingDiv.className = 'message bot typing-indicator';
                typingDiv.innerHTML = `
                    <span>Assistant is typing</span>
                    <div class="typing-dots">
                        <span></span>
                        <span></span>
                        <span></span>
                    </div>
                `;
                this.messages.appendChild(typingDiv);
                this.messages.scrollTop = this.messages.scrollHeight;
                return typingDiv;
            }

            async processMessage(userMessage) {
                this.isThinking = true;
                
                // Show thinking process
                const thinkingMsg = this.showThinking("Let me think about your question...");
                
                // Simulate thinking delay
                await new Promise(resolve => setTimeout(resolve, 1000));
                
                // Check for knowledge base matches first
                const response = this.getKnowledgeBaseResponse(userMessage);
                
                if (response) {
                    thinkingMsg.remove();
                    const typingMsg = this.showTyping();
                    
                    // Simulate typing delay
                    await new Promise(resolve => setTimeout(resolve, 1500));
                    typingMsg.remove();
                    
                    this.addMessage(response, 'bot');
                } else {
                    // If no direct match, use OpenAI API (if available)
                    await this.getOpenAIResponse(userMessage, thinkingMsg);
                }
                
                this.isThinking = false;
            }

            getKnowledgeBaseResponse(message) {
                const lowerMessage = message.toLowerCase();
                
                if (lowerMessage.includes('solflare') || lowerMessage.includes('wallet setup') || lowerMessage.includes('create wallet')) {
                    return this.knowledgeBase.solflareSetup;
                }
                
                if (lowerMessage.includes('seed phrase') || lowerMessage.includes('12 word') || lowerMessage.includes('recovery phrase') || lowerMessage.includes('secure')) {
                    return this.knowledgeBase.seedPhraseSecurity;
                }
                
                if (lowerMessage.includes('pumpfun') || lowerMessage.includes('fund') || lowerMessage.includes('transfer solana')) {
                    return this.knowledgeBase.pumpfunFunding;
                }
                
                if (lowerMessage.includes('buy jewel') || lowerMessage.includes('purchase jewel') || lowerMessage.includes('jewel icu')) {
                    return this.knowledgeBase.jewelicuPurchase;
                }
                
                if (lowerMessage.includes('graduation') || lowerMessage.includes('graduate') || lowerMessage.includes('benefits')) {
                    return this.knowledgeBase.graduation;
                }
                
                if (lowerMessage.includes('phantom') || lowerMessage.includes('connect phantom') || lowerMessage.includes('phantom wallet') || lowerMessage.includes('phantom mobile')) {
                    return this.knowledgeBase.phantomConnection;
                }
                
                // General help
                if (lowerMessage.includes('help') || lowerMessage.includes('what can you do')) {
                    return `I can help you with:
                    
                    ðŸ”¹ **Solflare Wallet Setup** - Creating and securing your wallet
                    ðŸ”¹ **Phantom Wallet Connection** - Connecting Phantom mobile app to Jewel.icu
                    ðŸ”¹ **Seed Phrase Security** - Protecting your 12-word recovery phrase
                    ðŸ”¹ **PumpFun Funding** - Transferring Solana to PumpFun
                    ðŸ”¹ **Jewel ICU Purchase** - Buying Jewel ICU tokens
                    ðŸ”¹ **Graduation Process** - Understanding benefits and requirements
                    
                    Just ask me about any of these topics!`;
                }
                
                return null;
            }

            async getOpenAIResponse(message, thinkingMsg) {
                try {
                    // Check if API key is properly configured
                    if (!this.apiKey || this.apiKey === 'sk-your-actual-openai-api-key-here') {
                        // Fallback response when no API key is configured
                        thinkingMsg.innerHTML = "ðŸ¤” Processing your question...";
                        await new Promise(resolve => setTimeout(resolve, 2000));
                        
                        thinkingMsg.remove();
                        const typingMsg = this.showTyping();
                        await new Promise(resolve => setTimeout(resolve, 1500));
                        typingMsg.remove();
                        
                        this.addMessage(`I understand you're asking about "${message}". While I have comprehensive knowledge about Solflare wallets, seed phrase security, PumpFun funding, and Jewel ICU purchases, I'd recommend using the quick question buttons above for the most detailed guidance.
                        
                        For specific technical questions, please try rephrasing your question to include keywords like "Solflare", "seed phrase", "PumpFun", "buy Jewel ICU", or "graduation".
                        
                        Is there a specific aspect of the Jewel ICU process you'd like me to explain in detail?`, 'bot');
                        return;
                    }

                    // Update thinking message for OpenAI processing
                    thinkingMsg.innerHTML = "ðŸ¤” Analyzing your question with OpenAI's advanced AI...";
                    
                    const systemPrompt = `You are a helpful assistant for Jewel ICU cryptocurrency. You specialize in:
                    - Solflare wallet setup and security
                    - Seed phrase protection
                    - PumpFun platform usage
                    - Jewel ICU token purchase process
                    - Graduation benefits and process
                    
                    Always provide accurate, helpful information and prioritize user security. Be conversational and helpful while maintaining expertise in cryptocurrency and wallet security.`;

                    // Add user message to conversation history
                    this.conversationHistory.push({
                        role: 'user',
                        content: message
                    });

                    // Prepare the API request
                    const response = await fetch('https://api.openai.com/v1/chat/completions', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${this.apiKey}`
                        },
                        body: JSON.stringify({
                            model: 'gpt-4o',  // Using GPT-4o for best performance
                            messages: [
                                { role: 'system', content: systemPrompt },
                                ...this.conversationHistory.slice(-10) // Keep last 10 messages for context
                            ],
                            max_tokens: 1000,
                            temperature: 0.7,
                            stream: false
                        })
                    });

                    if (!response.ok) {
                        throw new Error(`OpenAI API error: ${response.status}`);
                    }

                    const data = await response.json();
                    const aiResponse = data.choices[0].message.content;

                    // Add AI response to conversation history
                    this.conversationHistory.push({
                        role: 'assistant',
                        content: aiResponse
                    });

                    // Remove thinking message and show typing
                    thinkingMsg.remove();
                    const typingMsg = this.showTyping();
                    
                    // Simulate typing delay based on response length
                    const typingDelay = Math.min(3000, aiResponse.length * 20);
                    await new Promise(resolve => setTimeout(resolve, typingDelay));
                    typingMsg.remove();
                    
                    // Display the AI response
                    this.addMessage(aiResponse, 'bot');
                    
                } catch (error) {
                    console.error('OpenAI API Error:', error);
                    thinkingMsg.remove();
                    
                    // Provide helpful error message
                    let errorMessage = "I apologize, but I'm having trouble accessing the advanced AI features right now. ";
                    
                    if (error.message.includes('401')) {
                        errorMessage += "Please check that your OpenAI API key is valid and properly configured.";
                    } else if (error.message.includes('429')) {
                        errorMessage += "The AI service is currently busy. Please try again in a moment.";
                    } else {
                        errorMessage += "Please try using one of the quick question buttons above, or rephrase your question with specific keywords like 'Solflare', 'seed phrase', 'PumpFun', 'buy Jewel ICU', or 'graduation'.";
                    }
                    
                    this.addMessage(errorMessage, 'bot');
                }
            }
        }

        // â”€â”€ SPL Token helpers (replaces missing spl-token IIFE bundle) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        const _TOKEN_PROGRAM_ID = new solanaWeb3.PublicKey('TokenkegQfeZyiNwAJbNbGKPFXCWuBvf9Ss623VQ5DA');
        const _ASSOCIATED_TOKEN_PROGRAM_ID = new solanaWeb3.PublicKey('ATokenGPvbdGVxr1b2hvZbsiqW5xWH25efTNsLJe8bXo');

        function getAssociatedTokenAddressSync(mint, owner) {
            return solanaWeb3.PublicKey.findProgramAddressSync(
                [owner.toBuffer(), _TOKEN_PROGRAM_ID.toBuffer(), mint.toBuffer()],
                _ASSOCIATED_TOKEN_PROGRAM_ID
            )[0];
        }

        function createTransferCheckedInstruction(source, mint, destination, owner, amount, decimals) {
            const data = new Uint8Array(10);
            const view = new DataView(data.buffer);
            data[0] = 12;
            view.setBigUint64(1, BigInt(amount), true); // little-endian u64
            data[9] = decimals;
            return new solanaWeb3.TransactionInstruction({
                keys: [
                    { pubkey: source,      isSigner: false, isWritable: true  },
                    { pubkey: mint,        isSigner: false, isWritable: false },
                    { pubkey: destination, isSigner: false, isWritable: true  },
                    { pubkey: owner,       isSigner: true,  isWritable: false },
                ],
                programId: _TOKEN_PROGRAM_ID,
                data
            });
        }

        // â”€â”€ x402 Purchase: Buy JEWEL with USDC â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        class JewelPurchase {
            constructor() {
                this.buyBtn      = document.getElementById('buyJewelBtn');
                this.modal       = document.getElementById('purchaseModal');
                this.closeBtn    = document.getElementById('purchaseModalClose');
                this.amountInput = document.getElementById('jewelAmountInput');
                this.costDisplay = document.getElementById('usdcCostDisplay');
                this.confirmBtn  = document.getElementById('purchaseConfirmBtn');
                this.msgDiv      = document.getElementById('purchaseMessage');
                this.USDC_MINT   = 'EPjFWdd5AufqSSqeM2qN1xzybapC8G4wEGGkZwyTDt1v';
                this.PRICE       = 0.01; // USDC per JEWEL
                this.isProcessing = false;
                this.attachListeners();
            }

            attachListeners() {
                if (this.buyBtn)   this.buyBtn.addEventListener('click', () => this.openModal());
                if (this.closeBtn) this.closeBtn.addEventListener('click', () => this.closeModal());
                if (this.modal)    this.modal.addEventListener('click', e => { if (e.target === this.modal) this.closeModal(); });
                if (this.amountInput) this.amountInput.addEventListener('input', () => this.updateCostDisplay());
                if (this.confirmBtn)  this.confirmBtn.addEventListener('click', () => this.handlePurchase());
            }

            updateCostDisplay() {
                const amt = parseFloat(this.amountInput.value) || 0;
                if (this.costDisplay) {
                    this.costDisplay.textContent = (amt * this.PRICE).toFixed(2) + ' USDC';
                }
            }

            openModal() {
                if (!walletConnection || !walletConnection.connected) {
                    // Prompt wallet connection before opening the purchase modal
                    walletConnection.showToast('Connect your wallet to buy JEWEL', 'info');
                    const connectBtn = document.getElementById('connectWalletBtn');
                    if (connectBtn) connectBtn.click();
                    return;
                }
                if (this.modal) this.modal.classList.add('active');
                this.updateCostDisplay();
            }

            closeModal() {
                if (this.modal) this.modal.classList.remove('active');
                if (this.msgDiv) this.msgDiv.textContent = '';
            }

            showMessage(text, type) {
                if (!this.msgDiv) return;
                this.msgDiv.textContent = text;
                this.msgDiv.style.color = type === 'error' ? '#ff6b6b'
                                        : type === 'success' ? '#00E676'
                                        : '#FFD700';
            }

            async handlePurchase() {
                if (this.isProcessing) return;

                if (!walletConnection || !walletConnection.connected) {
                    this.showMessage('Please connect your wallet first.', 'error');
                    return;
                }

                const jewelAmount = parseInt(this.amountInput.value, 10);
                if (!jewelAmount || jewelAmount < 1) {
                    this.showMessage('Please enter a valid amount (minimum 1).', 'error');
                    return;
                }

                this.isProcessing = true;
                this.confirmBtn.disabled = true;
                this.confirmBtn.textContent = 'Requesting payment details\u2026';
                this.showMessage('', '');

                try {
                    // Step 1: call backend with no payment header â€” expect 402
                    const initRes = await fetch(`${AIRDROP_API_URL}/api/purchase/jewel`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            walletAddress: walletConnection.provider.publicKey.toString(),
                            jewelAmount
                        })
                    });

                    if (initRes.status !== 402) {
                        const errData = await initRes.json().catch(() => ({}));
                        throw new Error(errData.error || 'Unexpected response from server');
                    }

                    const payReqs = await initRes.json();
                    const accepts = payReqs.accepts[0];

                    // Step 2: build USDC transferChecked transaction
                    this.confirmBtn.textContent = 'Approve in wallet\u2026';
                    this.showMessage('Building USDC transaction\u2026', 'info');

                    const conn = new solanaWeb3.Connection(
                        'https://rpc.ankr.com/solana', 'confirmed'
                    );
                    const userPubkey  = walletConnection.provider.publicKey;
                    const usdcMint    = new solanaWeb3.PublicKey(this.USDC_MINT);
                    const fromAta     = getAssociatedTokenAddressSync(usdcMint, userPubkey);
                    const toAta       = new solanaWeb3.PublicKey(accepts.payTo);
                    const usdcAmount  = BigInt(accepts.maxAmountRequired);

                    const ix = createTransferCheckedInstruction(
                        fromAta, usdcMint, toAta, userPubkey, usdcAmount, 6
                    );

                    const { blockhash } = await conn.getLatestBlockhash();
                    const tx = new solanaWeb3.Transaction({
                        feePayer: userPubkey,
                        recentBlockhash: blockhash
                    }).add(ix);

                    // Step 3: user signs in wallet
                    const signedTx = await walletConnection.provider.signTransaction(tx);
                    const serialized = signedTx.serialize();
                    const paymentHeader = btoa(
                        Array.from(serialized, b => String.fromCharCode(b)).join('')
                    );

                    // Step 4: send payment to backend
                    this.confirmBtn.textContent = 'Processing payment\u2026';
                    this.showMessage('Broadcasting payment\u2026', 'info');

                    const buyRes = await fetch(`${AIRDROP_API_URL}/api/purchase/jewel`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-PAYMENT': JSON.stringify({
                                scheme: 'exact',
                                network: 'solana-mainnet',
                                payload: paymentHeader
                            })
                        },
                        body: JSON.stringify({
                            walletAddress: walletConnection.provider.publicKey.toString(),
                            jewelAmount
                        })
                    });

                    const buyData = await buyRes.json();
                    if (!buyRes.ok) throw new Error(buyData.error || 'Purchase failed');

                    const shortSig = buyData.transactionSignature.slice(0, 12) + '\u2026';
                    this.showMessage(`\u2713 ${jewelAmount} JEWEL sent! Tx: ${shortSig}`, 'success');
                    walletConnection.showToast(`\uD83D\uDC8E Purchased ${jewelAmount} JEWEL!`, 'success');

                    setTimeout(() => this.closeModal(), 3000);

                } catch (err) {
                    this.showMessage('Error: ' + err.message, 'error');
                } finally {
                    this.isProcessing = false;
                    this.confirmBtn.disabled = false;
                    this.confirmBtn.textContent = 'Pay with USDC \u2192';
                }
            }
        }

        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', () => {
            walletConnection = new SolflareWalletConnection();
            new JewelICUChatbot();
            new JewelAirdrop();
            new JewelPurchase();

            // For mobile/in-app browsers, check connection status after a delay
            setTimeout(() => {
                if (window.solana && window.solana.isConnected && window.solana.publicKey) {
                    console.log('Mobile wallet detected as connected on load');
                    walletConnection.handleConnection(window.solana.publicKey.toString());
                }
            }, 1000);
        });

        // Check for Solflare installation after a delay (for extension loading)
        window.addEventListener('load', () => {
            setTimeout(() => {
                if (walletConnection && !window.solflare) {
                    // Check again after a longer delay in case extension is slow to load
                    setTimeout(() => {
                        if (!window.solflare || !window.solflare.isSolflare) {
                            console.log('Solflare wallet extension not detected');
                            // Update button to show installation hint
                            const connectBtn = document.getElementById('connectWalletBtn');
                            if (connectBtn && !walletConnection.connected) {
                                connectBtn.title = 'Click to install Solflare wallet';
                            }
                        }
                    }, 2000);
                }
            }, 1000);
        });
    </script>

    <!-- Token Lock Integration Script -->
    <script type="module">
        import { TokenLockClient, tokenLockUtils } from './js/tokenLock.js';

        // Token Lock Integration
        class TokenLockIntegration {
            constructor() {
                this.tokenLockClient = null;
                this.selectedDuration = null;
                this.initializeElements();
                this.attachEventListeners();
            }

            initializeElements() {
                this.lockButton = document.getElementById('tokenLockButton');
                this.modal = document.getElementById('tokenLockModal');
                this.closeButton = document.getElementById('tokenLockClose');
                this.form = document.getElementById('tokenLockForm');
                this.durationButtons = document.querySelectorAll('.duration-btn');
                this.customDurationInput = document.getElementById('customDurationInput');
                this.lockSubmitButton = document.getElementById('lockSubmitButton');
                this.userLocksDiv = document.getElementById('userLocks');
                this.lockMessageDiv = document.getElementById('lockMessage');
            }

            attachEventListeners() {
                this.lockButton.addEventListener('click', () => this.openModal());
                this.closeButton.addEventListener('click', () => this.closeModal());
                this.modal.addEventListener('click', (e) => {
                    if (e.target === this.modal) this.closeModal();
                });

                this.durationButtons.forEach(btn => {
                    btn.addEventListener('click', () => this.selectDuration(btn));
                });

                this.customDurationInput.addEventListener('input', () => {
                    if (this.customDurationInput.value) {
                        this.durationButtons.forEach(btn => btn.classList.remove('active'));
                        this.selectedDuration = parseInt(this.customDurationInput.value);
                    }
                });

                this.form.addEventListener('submit', (e) => this.handleLockTokens(e));
            }

            openModal() {
                if (!walletConnection || !walletConnection.connected) {
                    walletConnection.showToast('Please connect your wallet first', 'error');
                    return;
                }

                this.modal.classList.add('active');
                this.initializeTokenLockClient();
                this.loadUserLocks();
            }

            closeModal() {
                this.modal.classList.remove('active');
            }

            selectDuration(button) {
                this.durationButtons.forEach(btn => btn.classList.remove('active'));
                button.classList.add('active');
                this.selectedDuration = parseInt(button.dataset.duration);
                this.customDurationInput.value = '';
            }

            initializeTokenLockClient() {
                if (!this.tokenLockClient && walletConnection && walletConnection.provider) {
                    const connection = new solanaWeb3.Connection(
                        solanaWeb3.clusterApiUrl('devnet'),
                        'confirmed'
                    );
                    this.tokenLockClient = tokenLockUtils.createClient(connection, walletConnection.provider);
                }
            }

            async handleLockTokens(e) {
                e.preventDefault();

                if (!this.tokenLockClient) {
                    this.showMessage('Please connect your wallet first', 'error');
                    return;
                }

                const tokenMint = document.getElementById('tokenMintInput').value;
                const amount = document.getElementById('lockAmountInput').value;
                const duration = this.selectedDuration || parseInt(this.customDurationInput.value);

                if (!tokenMint || !amount || !duration) {
                    this.showMessage('Please fill in all fields', 'error');
                    return;
                }

                this.lockSubmitButton.disabled = true;
                this.lockSubmitButton.textContent = 'Locking...';

                try {
                    // Check if vault exists, create if not
                    const vaultExists = await this.tokenLockClient.vaultExists(new solanaWeb3.PublicKey(tokenMint));
                    
                    if (!vaultExists) {
                        this.showMessage('Creating vault for token...', 'info');
                        const vaultResult = await this.tokenLockClient.initializeVault(new solanaWeb3.PublicKey(tokenMint));
                        
                        if (!vaultResult.success) {
                            throw new Error(vaultResult.error);
                        }
                    }

                    // Lock tokens
                    const parsedAmount = tokenLockUtils.parseTokenAmount(amount);
                    const result = await this.tokenLockClient.lockTokens(
                        new solanaWeb3.PublicKey(tokenMint),
                        parsedAmount,
                        duration
                    );

                    if (result.success) {
                        this.showMessage(
                            `Successfully locked ${amount} tokens until ${result.unlockTimestamp.toLocaleString()}`,
                            'success'
                        );
                        
                        // Reload user locks
                        await this.loadUserLocks();
                        
                        // Clear form
                        this.form.reset();
                        this.selectedDuration = null;
                        this.durationButtons.forEach(btn => btn.classList.remove('active'));
                    } else {
                        throw new Error(result.error);
                    }
                } catch (error) {
                    this.showMessage(`Error: ${error.message}`, 'error');
                } finally {
                    this.lockSubmitButton.disabled = false;
                    this.lockSubmitButton.textContent = 'Lock Tokens';
                }
            }

            async loadUserLocks() {
                if (!this.tokenLockClient) return;

                this.userLocksDiv.innerHTML = '<p style="color: #999;">Loading...</p>';

                try {
                    // For demo, check the Jewel ICU token mint
                    // In production, you'd want to get this from user's token accounts
                    const jewelIcuMint = '37ApeZ2X8dwKZkV22wDqLzDFh4QRkTMSvkc3uau6pump';
                    
                    const lockInfo = await this.tokenLockClient.getLockInfo(
                        new solanaWeb3.PublicKey(jewelIcuMint),
                        walletConnection.provider.publicKey
                    );
                    
                    if (lockInfo.success && lockInfo.lockInfo && !lockInfo.lockInfo.isUnlocked) {
                        this.userLocksDiv.innerHTML = this.createLockItem(lockInfo.lockInfo, jewelIcuMint);
                    } else {
                        this.userLocksDiv.innerHTML = '<p style="color: #999;">No locked tokens found</p>';
                    }
                } catch (error) {
                    this.userLocksDiv.innerHTML = '<p style="color: #999;">No locked tokens found</p>';
                }
            }

            createLockItem(lock, mint) {
                const canUnlock = lock.canUnlock;
                const timeClass = canUnlock ? 'style="color: #4CAF50;"' : '';
                
                return `
                    <div class="lock-item">
                        <div class="lock-item-info">
                            <div>
                                <div class="lock-item-detail">
                                    <strong>Amount:</strong> ${tokenLockUtils.formatTokenAmount(lock.amount)}
                                </div>
                                <div class="lock-item-detail">
                                    <strong>Unlock Time:</strong> ${lock.unlockTimestamp.toLocaleString()}
                                </div>
                                <div class="lock-item-detail">
                                    <strong>Time Remaining:</strong> <span ${timeClass}>${lock.timeRemainingFormatted}</span>
                                </div>
                            </div>
                            ${canUnlock ? `
                                <button class="unlock-btn" onclick="tokenLockIntegration.unlockTokens('${mint}')">
                                    Unlock
                                </button>
                            ` : ''}
                        </div>
                    </div>
                `;
            }

            async unlockTokens(tokenMint) {
                if (!this.tokenLockClient) {
                    this.showMessage('Please connect your wallet first', 'error');
                    return;
                }

                if (confirm('Are you sure you want to unlock these tokens?')) {
                    try {
                        const result = await this.tokenLockClient.unlockTokens(new solanaWeb3.PublicKey(tokenMint));
                        
                        if (result.success) {
                            this.showMessage('Tokens unlocked successfully!', 'success');
                            await this.loadUserLocks();
                        } else {
                            throw new Error(result.error);
                        }
                    } catch (error) {
                        this.showMessage(`Error unlocking tokens: ${error.message}`, 'error');
                    }
                }
            }

            showMessage(message, type) {
                this.lockMessageDiv.innerHTML = `<div class="message ${type}">${message}</div>`;
                
                if (type !== 'error') {
                    setTimeout(() => {
                        this.lockMessageDiv.innerHTML = '';
                    }, 5000);
                }
            }
        }

        // Initialize token lock integration
        window.tokenLockIntegration = new TokenLockIntegration();

        // Check for lock info when wallet connects
        const originalHandleConnection = walletConnection.handleConnection;
        walletConnection.handleConnection = function(publicKey) {
            originalHandleConnection.call(this, publicKey);
            if (window.tokenLockIntegration) {
                window.tokenLockIntegration.initializeTokenLockClient();
                if (window.tokenLockIntegration.modal.classList.contains('active')) {
                    window.tokenLockIntegration.loadUserLocks();
                }
            }
        };
    </script>
    
    <!-- Wallet Connection Fix for Solflare -->
    <script src="simple-wallet-fix.js"></script>

    <!-- Purchase Modal (x402) -->
    <div id="purchaseModal">
        <div class="purchase-modal-content">
            <button class="purchase-close-btn" id="purchaseModalClose">âœ•</button>
            <h2>Buy JEWEL Tokens</h2>
            <span class="x402-badge">Powered by x402 &middot; Pay with USDC</span>
            <label class="purchase-input-label" for="jewelAmountInput">Amount of JEWEL to buy</label>
            <input type="number" id="jewelAmountInput" class="purchase-amount-input"
                   min="1" step="1" value="100" placeholder="e.g. 100">
            <div class="purchase-summary">
                Cost: <span id="usdcCostDisplay">1.00 USDC</span>
                &nbsp;&middot;&nbsp; Rate: 0.01 USDC / JEWEL
            </div>
            <div id="purchaseMessage" style="min-height: 20px; margin-bottom: 12px; font-size: 13px;"></div>
            <button class="purchase-confirm-btn" id="purchaseConfirmBtn">Pay with USDC &rarr;</button>
        </div>
    </div>
</body>
</html>
